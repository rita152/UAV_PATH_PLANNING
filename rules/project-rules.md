# UAV路径规划项目开发规范

## 项目概述
本项目是一个基于深度强化学习（SAC算法）的无人机路径规划系统，用于多智能体协同避障和目标追踪。

## 代码规范

### Python代码风格
- 遵循PEP 8代码风格规范
- 使用4个空格进行缩进，不使用Tab
- 类名使用大驼峰命名（CamelCase）
- 函数和变量使用小写下划线命名（snake_case）
- 常量使用全大写下划线命名（UPPER_SNAKE_CASE）

### 命名规范
- **环境类**：以`Env`结尾，如`RlGame`、`PathEnv`
- **神经网络类**：以`Net`结尾，如`ActorNet`、`CriticNet`
- **智能体类**：使用清晰的名称，如`Actor`、`Critic`、`Memory`
- **函数名**：使用动词开头，清晰描述功能，如`choose_action`、`learn`、`reset`
- **变量名**：避免使用单字母变量（除循环变量`i`、`j`外）

### 文件组织
```
UAV_PATH_PLANNING/
├── algorithm/          # 算法实现
│   └── masac/         # MASAC算法相关代码
├── rl_env/            # 强化学习环境
│   ├── __init__.py
│   └── path_env.py    # 路径规划环境
├── utils/             # 工具函数
├── assignment/        # 仿真相关组件
│   ├── components/    # 组件（player等）
│   └── source/        # 资源文件（图片、音频）
├── docs/              # 文档
├── rules/             # 项目规范
└── main_SAC.py        # 主程序入口
```

## 开发规范

### 1. 环境配置
- **Python版本**：建议使用Python 3.7+
- **必需依赖**：
  - PyTorch >= 1.7.0
  - Gym
  - Pygame
  - NumPy
  - Matplotlib

### 2. 超参数管理
- 所有超参数应在文件开头集中定义
- 使用全大写命名超参数常量
- 重要超参数应添加注释说明
```python
# 训练参数
EP_MAX = 500          # 最大训练轮数
EP_LEN = 1000         # 每轮最大步数
BATCH = 128           # 批次大小
GAMMA = 0.9           # 折扣因子
```

### 3. 路径管理
- **禁止硬编码绝对路径**
- 使用相对路径或配置文件管理路径
- 模型保存路径应使用项目相对路径
```python
# 不推荐
shoplistfile = '/home/zp/vscode_projects/path planning/MASAC_new1'

# 推荐
import os
PROJECT_ROOT = os.path.dirname(os.path.abspath(__file__))
shoplistfile = os.path.join(PROJECT_ROOT, 'saved_models', 'MASAC_new1')
```

### 4. 代码注释
- 类和函数必须添加文档字符串（docstring）
- 复杂算法逻辑添加行内注释
- 使用中文或英文注释保持一致性

#### 函数注释示例
```python
def choose_action(self, state):
    """
    根据当前状态选择动作
    
    Args:
        state: 当前状态，numpy数组
        
    Returns:
        action: 选择的动作，numpy数组
    """
    pass
```

### 5. 神经网络规范
- 网络初始化使用正态分布初始化权重
- 明确指定激活函数
- Critic网络使用Double Q-learning架构
- Actor网络输出使用tanh激活并缩放到动作空间

### 6. 训练流程规范
- 使用经验回放缓冲区（Replay Buffer）
- 实现软更新（Soft Update）机制
- 添加探索噪声（Ornstein-Uhlenbeck或高斯噪声）
- 定期保存模型检查点

### 7. 奖励函数设计
奖励函数应包含以下组成部分：
- **边界惩罚**：防止无人机越界
- **避障奖励**：根据与障碍物距离给予奖励/惩罚
- **目标奖励**：引导无人机向目标移动
- **编队奖励**：多智能体保持队形
- **速度奖励**：鼓励速度匹配

### 8. 环境实现规范
- 继承`gym.Env`类
- 实现必需方法：`reset()`、`step()`、`render()`、`close()`
- 定义动作空间和观察空间
- 状态归一化到合理范围（如[0,1]或[-1,1]）

### 9. 测试规范
- 训练模式（`Switch=0`）和测试模式（`Switch=1`）分离
- 测试时记录关键指标：
  - 任务完成率
  - 平均编队保持率
  - 平均飞行时间
  - 平均飞行路程
  - 平均能量损耗

### 10. 可视化规范
- 使用matplotlib绘制训练曲线
- 显示均值和标准差区间
- 使用Pygame进行实时仿真可视化
- 轨迹可视化使用不同颜色区分不同智能体

## Git提交规范

### 提交信息格式
```
<type>: <subject>

<body>

<footer>
```

### Type类型
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建或辅助工具变动

### 示例
```
feat: 添加多智能体编队保持奖励

- 在奖励函数中添加编队距离计算
- 实现速度匹配奖励机制
- 更新step函数返回编队计数器

Closes #12
```

## 性能优化建议

### 1. 训练优化
- 使用GPU加速训练（`device = torch.device("cuda")`）
- 批量处理状态转换
- 合理设置经验池大小（建议10000-50000）
- 使用并行环境加速数据收集

### 2. 代码优化
- 避免在循环中重复创建对象
- 使用NumPy向量化操作
- 减少不必要的数据复制

### 3. 内存管理
- 及时释放大型数组
- 使用`torch.no_grad()`减少梯度计算开销
- 定期清理经验池

## 调试规范

### 1. 日志输出
- 使用`print`输出关键训练信息
- 每轮输出：Episode编号、总奖励
- 定期输出：网络损失、学习率等

### 2. 断言检查
- 在关键位置添加断言验证数据有效性
- 检查数组维度是否正确
- 验证动作范围是否在有效区间

### 3. 可视化调试
- 使用tensorboard记录训练过程
- 绘制轨迹图检查路径规划效果
- 可视化奖励曲线和损失曲线

## 安全规范

### 1. 数据安全
- 不在代码中硬编码敏感信息
- 使用`.gitignore`忽略模型文件和数据文件
- 定期备份训练好的模型

### 2. 异常处理
- 使用try-except捕获可能的异常
- 训练中断后能够恢复训练
- 保存检查点时验证文件完整性

## 文档规范

### 1. README.md
- 项目简介和功能说明
- 安装和使用教程
- 参数配置说明
- 常见问题解答

### 2. 代码文档
- 关键算法添加详细注释
- 复杂数学公式使用注释解释
- API接口提供使用示例

### 3. 更新日志
- 记录版本更新内容
- 标注重要的变更和破坏性修改

## 协作规范

### 1. 分支管理
- `main`：稳定版本分支
- `develop`：开发分支
- `feature/*`：功能开发分支
- `fix/*`：bug修复分支

### 2. Code Review
- 代码合并前进行审查
- 检查代码风格和规范
- 验证功能正确性

### 3. Issue管理
- 使用Issue跟踪bug和新功能需求
- 清晰描述问题和复现步骤
- 关联相关的Pull Request

## 扩展性考虑

### 1. 模块化设计
- 算法、环境、网络结构分离
- 便于替换不同的RL算法
- 支持自定义奖励函数

### 2. 配置化
- 使用配置文件管理超参数
- 支持命令行参数传入
- 便于进行参数搜索和调优

### 3. 可扩展性
- 支持添加新的智能体类型
- 支持自定义环境组件
- 便于集成其他RL算法

---

**最后更新时间**: 2025-10-28  
**维护者**: 项目开发团队

